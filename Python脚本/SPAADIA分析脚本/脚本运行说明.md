# SPAADIA分析脚本运行说明

更新日期：2025-08-15

## 一、脚本概述

本系统包含Python和R两种语言的脚本，相互配合完成完整的统计分析和验证。

### Python脚本分类
1. **工具模块**（不需要单独运行）
   - `advanced_statistics.py` - 高级统计工具库
   - `data_loader_enhanced.py` - 数据加载模块

2. **分析脚本**（可单独或批量运行）
   - 基础分析：`section_3_1_analysis.py`, `hypothesis_h1/h2/h3/h4_analysis.py`
   - 高级分析：`hypothesis_h1/h2/h3/h4_advanced.py`

3. **补充分析脚本**（2025-08-15新增）
   - `power_analysis.py` - 统计功效分析
   - `fdr_correction.py` - FDR多重比较校正
   - `sensitivity_analysis.py` - 敏感性分析

4. **集成脚本**（用于批量执行）
   - `run_all_analyses_advanced.py` - 主运行脚本
   - `run_supplementary_analyses.py` - 补充分析运行脚本（新增）
   - `data_bridge_for_R.py` - 数据准备脚本
   - `integrate_r_validation.py` - 结果整合脚本

5. **可视化工具**（按需运行）
   - `create_flowchart_pillow.py` - 创建流程图
   - `create_multilevel_flowchart.py` - 创建多层流程图

### R脚本功能
1. **validation_scripts.R** - 基础验证（H1、H3）
2. **validation_scripts_quiet.R** - 静默版本
3. **comprehensive_validation.R** - 综合验证（H1-H4）

## 二、R脚本使用说明

### R脚本与Python的配合方式

R脚本主要用于**验证Python分析结果的准确性**，特别是：
- 混合效应模型（使用lme4包）
- 马尔可夫链分析（使用markovchain包）
- Kenward-Roger自由度调整

### R脚本运行时机

1. **自动运行**（推荐）
   - 使用`run_all_analyses_advanced.py`时会自动调用R验证
   - 结果通过`integrate_r_validation.py`整合到报告中

2. **手动运行**（特殊需求）
   ```bash
   # 先准备数据
   python data_bridge_for_R.py
   
   # 运行R验证
   Rscript validation_scripts.R
   
   # 或运行综合验证
   Rscript comprehensive_validation.R
   
   # 整合结果
   python integrate_r_validation.py
   ```

## 三、完整运行流程

### 方式一：一键运行（推荐）

```bash
cd "G:\Project\实证\关联框架\Python脚本\SPAADIA分析脚本"
python run_all_analyses_advanced.py
```

这会自动执行：
1. ✅ 基础分析（5个脚本）
2. ✅ 高级分析（4个脚本）
3. ✅ R验证（validation_scripts.R）
4. ✅ 结果整合

### 方式二：包含补充分析的完整流程（2025-08-15新增）

#### 步骤1：运行Python分析
```bash
# 运行所有基础分析
python section_3_1_analysis.py
python hypothesis_h1_analysis.py
python hypothesis_h2_analysis.py
python hypothesis_h3_analysis.py
python hypothesis_h4_analysis.py

# 运行所有高级分析
python hypothesis_h1_advanced.py
python hypothesis_h2_advanced.py
python hypothesis_h3_advanced.py
python hypothesis_h4_advanced.py
```

#### 步骤2：运行补充分析（新增）
```bash
# 运行统计功效分析、FDR校正、敏感性分析
python run_supplementary_analyses.py

# 或单独运行各补充分析
python power_analysis.py       # 统计功效分析
python fdr_correction.py        # FDR多重比较校正
python sensitivity_analysis.py  # 敏感性分析
```

#### 步骤3：准备R验证数据
```bash
python data_bridge_for_R.py
```

#### 步骤4：运行R验证
```bash
# 基础验证
Rscript validation_scripts.R

# 或综合验证（更全面）
Rscript comprehensive_validation.R
```

#### 步骤5：整合结果
```bash
python integrate_r_validation.py
```

### 方式三：选择性运行

```bash
# 只运行基础分析
python run_all_analyses_advanced.py --skip-advanced

# 只运行高级分析
python run_all_analyses_advanced.py --skip-basic

# 运行单个假设分析
python hypothesis_h2_analysis.py
python hypothesis_h2_advanced.py
```

## 四、输出说明

### 输出目录结构
```
G:\Project\实证\关联框架\
├── 输出\              # 中文输出
│   ├── data\         # JSON统计结果
│   ├── tables\       # CSV数据表格
│   ├── figures\      # JPG图表(1200 DPI)
│   ├── reports\      # Markdown报告
│   └── logs\         # 运行日志
└── output\           # 英文输出（结构相同）
```

### 主要输出文件
1. **统计表格**（表1-11）：各假设的统计结果
2. **可视化图形**（图1-5）：高分辨率图表（含增强版本）
3. **分析报告**：每个假设的详细报告
4. **R验证结果**：`r_validation_results.json`
5. **最终汇总**：`python_r_integration_report.md`
6. **可视化指南**：`enhanced_visualization_guide.md`
7. **补充分析结果**（2025-08-15新增）：
   - `power_analysis_report.md` - 统计功效分析报告
   - `fdr_correction_report.md` - FDR校正报告
   - `sensitivity_analysis_report.md` - 敏感性分析报告
   - `supplementary_analyses_summary.md` - 补充分析汇总

## 五、环境要求

### Python环境
```bash
# 查看Python版本（需要>=3.7）
python --version

# 安装依赖
pip install -r requirements.txt
```

### R环境
```bash
# 查看R版本（需要>=4.0）
R --version

# 在R中安装必需包
install.packages(c("lme4", "pbkrtest", "markovchain", "jsonlite"))
```

## 六、常见问题

### Q1: R脚本是否必须运行？
**答**：不是必须的。R脚本主要用于验证关键统计结果的准确性。如果只需要Python分析结果，可以跳过R验证。

### Q2: 为什么需要data_bridge_for_R.py？
**答**：因为R和Python的数据格式不同，需要将Python处理后的数据转换为R可以读取的格式（CSV）。

### Q3: 可以只运行某个假设的分析吗？
**答**：可以。每个hypothesis_*.py脚本都可以独立运行。

### Q4: advanced_statistics.py需要运行吗？
**答**：不需要。它是工具模块，被其他高级分析脚本调用。

### Q5: R验证失败怎么办？
**答**：检查R环境和包是否安装正确。Python分析结果仍然有效，只是缺少R的交叉验证。

## 七、策略类型说明

系统已实现策略合并（5→3）：
- `frame_reinforcement`（框架强化）- 包含原框架响应
- `frame_shifting`（框架转换）- 包含原框架抵抗
- `frame_blending`（框架融合）

## 八、执行时间估计

- 完整运行（基础+高级+R验证）：约15-20分钟
- 仅基础分析：约5-8分钟
- 仅高级分析：约8-10分钟
- R验证：约2-3分钟

## 九、调试提示

如需查看详细执行过程：
1. 查看日志文件：`输出/logs/`目录
2. 单独运行脚本时会在控制台显示进度
3. R脚本使用`validation_scripts_quiet.R`可减少输出

## 十、最佳实践

1. **首次运行**：使用`python run_all_analyses_advanced.py`确保系统正常
2. **日常使用**：根据需要选择性运行特定分析
3. **发表论文**：确保运行R验证以增强结果可信度
4. **调试问题**：从单个脚本开始逐步排查
5. **可视化增强**：参考`enhanced_visualization_guide.md`进行图形优化

## 十一、重要更新说明

### 2025-08-15 更新
- ✅ **新增补充分析模块**：
  - 统计功效分析（power_analysis.py）：蒙特卡洛模拟评估各假设检验功效
  - FDR校正（fdr_correction.py）：Benjamini-Hochberg方法控制多重比较错误
  - 敏感性分析（sensitivity_analysis.py）：三维度评估方法选择影响
  - 综合运行脚本（run_supplementary_analyses.py）：一键运行所有补充分析
- ✅ **文档完善**：
  - 更新2.4小节，修正软件版本和方法描述的不一致
  - 澄清Python和R的实际分工
  - 承认多层多项逻辑回归的技术限制

### 2025-01-31 更新

### H1高级分析重大更新（V2版本）
- ✅ **完全重写**：实现渐进式三层线性混合模型
- ✅ **仅使用真实数据**：移除所有模拟数据生成代码
- ✅ **智能模型选择**：根据收敛情况自动调整模型复杂度
  - M2a: 尝试完整随机斜率模型（CD和IP随机）
  - M2b: 如失败，退回到简化模型（仅CD随机）
  - M2c: 如仍失败，使用随机截距模型
- ✅ **理论依据充分**：基于小样本统计理论的渐进式策略
- ✅ **稳定性保证**：避免奇异矩阵和收敛问题

### H2高级分析增强
- ✅ 实现了多层多项逻辑回归
- ✅ 考虑了数据的层次结构
- ✅ 提供了更准确的策略选择预测
- ✅ 删除了与2.4小节无关的功能

### 其他改进
- ✅ 修复了多重插补中的Categorical类型处理
- ✅ 新增`enhanced_visualization_guide.md`文档
- ✅ 提供了H1-H4假设的增强图形方案
- ✅ 包含统计严谨性和视觉清晰性指导


高级分析脚本（H1-H4 advanced）是独立的，不依赖基础分析的输出。以下是关键证据：

  1. 数据来源独立

  - 高级分析脚本使用 SPAADIADataLoader 直接从原始数据加载
  - 数据加载器从 SPAADIA 原始文件（JSONL/JSON/XML）读取数据
  - 不依赖基础分析的任何输出文件

  2. 运行选项灵活

  run_all_analyses_advanced.py 提供了三种运行模式：

  # 运行基础+高级分析（默认）
  python run_all_analyses_advanced.py

  # 仅运行高级分析（跳过基础）
  python run_all_analyses_advanced.py --skip-basic

  # 仅运行基础分析（跳过高级）
  python run_all_analyses_advanced.py --skip-advanced

  3. 设计理念

  - 基础分析：提供标准的统计分析
  - 高级分析：提供增强的统计方法（如三层模型、Bootstrap等）
  - 两者是平行关系而非依赖关系

  4. 实际使用建议

  如果您只想要最新、最完善的分析结果：
  # 直接运行高级分析即可
  python run_all_analyses_advanced.py --skip-basic

  如果您想要对比基础和高级分析的结果：
  # 运行两种分析
  python run_all_analyses_advanced.py

  5. 输出结构

  两种分析的输出是独立的：
  - 基础分析：hypothesis_h1_results.json
  - 高级分析：h1_threelevel_results.json

  所以您可以根据需要选择运行哪种分析，高级分析包含了所有必要的统计方法，完全可以独立运行。